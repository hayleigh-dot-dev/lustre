var f=class{withFields(e){let n=Object.keys(this).map(u=>u in e?e[u]:this[u]);return new this.constructor(...n)}},x=class{static fromArray(e,n){let u=n||new _;return e.reduceRight((l,a)=>new L(a,l),u)}[Symbol.iterator](){return new k(this)}toArray(){return[...this]}atLeastLength(e){for(let n of this){if(e<=0)return!0;e--}return e<=0}hasLength(e){for(let n of this){if(e<=0)return!1;e--}return e===0}countLength(){let e=0;for(let n of this)e++;return e}};var k=class{#e;constructor(e){this.#e=e}next(){if(this.#e instanceof _)return{done:!0};{let{head:e,tail:n}=this.#e;return this.#e=n,{value:e,done:!1}}}},_=class extends x{},L=class extends x{constructor(e,n){super(),this.head=e,this.tail=n}};var y=class t extends f{static isResult(e){return e instanceof t}},h=class extends y{constructor(e){super(),this[0]=e}isOk(){return!0}},c=class extends y{constructor(e){super(),this[0]=e}isOk(){return!1}};function p(t,e,n,u,l,a){let r=new globalThis.Error(l);r.gleam_error=t,r.module=e,r.line=n,r.fn=u;for(let s in a)r[s]=a[s];return r}var zt=new DataView(new ArrayBuffer(8));var G=5,A=Math.pow(2,G),It=A-1,Ct=A/2,Tt=A/4;function O(t,e){if(t.isOk()){let n=t[0];return new h(e(n))}else{if(t.isOk())throw p("case_no_match","gleam/result",67,"map","No case clause matched",{values:[t]});{let n=t[0];return new c(n)}}}function d(t,e,n,u){if(e?.tag&&t?.nodeType===1){let l=e.tag.toUpperCase(),a=e.namespace||"http://www.w3.org/1999/xhtml";return t.nodeName===l&&t.namespaceURI==a?Z(t,e,n,u):B(t,e,n,u)}return e?.tag?B(t,e,n,u):typeof e?.content=="string"?t?.nodeType===3?ee(t,e):Q(t,e):document.createComment(["[internal lustre error] I couldn't work out how to render this element. This","function should only be called internally by lustre's runtime: if you think","this is an error, please open an issue at","https://github.com/hayleigh-dot-dev/gleam-lustre/issues/new"].join(" "))}function D(t,e,n){for(let u of t[0]){let l=u[0];if(l==="0")d(e,u[1],n);else{let a=Array.from(l),r=a.slice(0,-1).join(""),s=a.slice(-1)[0],i=e.querySelector(`[data-lustre-key="${l}"]`)??e.querySelector(`[data-lustre-key="${r}"]`).childNodes[s];d(i,u[1],n,i.parentNode)}}for(let u of t[2]){let l=u[0],a=Array.from(l),r=a.slice(0,-1).join(""),s=a.slice(-1)[0];(e.querySelector(`[data-lustre-key="${l}"]`)??e.querySelector(`[data-lustre-key="${r}"]`).childNodes[s]).remove()}for(let u of t[2]){let l=u[0],a=l==="0"?e:e.querySelector(`[data-lustre-key="${l}"]`),r=a.attributes,s=new Map;a.$lustre??={__registered_events:new Set};for(let i of u[1])i[0]==="class"&&s.has("class")?s.set(i[0],`${s.get("class")} ${i[1]}`):i[0]==="style"&&s.has("style")?s.set(i[0],`${s.get("style")} ${i[1]}`):i[0]==="dangerous-unescaped-html"&&s.has("dangerous-unescaped-html")?s.set(i[0],`${s.get("dangerous-unescaped-html")} ${i[1]}`):i[0]!==""&&s.set(i[0],i[1]);for(let{name:i,value:o}of r)if(!s.has(i))a.removeAttribute(i);else{let g=s.get(i);g!==o&&(m(a,i,g,n),s.delete(i))}for(let i of a.$lustre.__registered_events)if(!s.has(i)){let o=i.slice(2).toLowerCase();a.removeEventListener(o,a.$lustre[`${i}Handler`]),a.$lustre.__registered_events.delete(i),delete a.$lustre[i],delete a.$lustre[`${i}Handler`]}for(let[i,o]of s)m(a,i,o,n)}return e}function B(t,e,n,u=null){let l=e.namespace?document.createElementNS(e.namespace,e.tag):document.createElement(e.tag);l.$lustre={__registered_events:new Set};let a="";for(let r of e.attrs)r[0]==="class"?m(l,r[0],`${l.className} ${r[1]}`):r[0]==="style"?m(l,r[0],`${l.style.cssText} ${r[1]}`):r[0]==="dangerous-unescaped-html"?a+=r[1]:r[0]!==""&&m(l,r[0],r[1],n);if(customElements.get(e.tag))l._slot=e.children;else if(e.tag==="slot"){let r=new _,s=u;for(;s;)if(s._slot){r=s._slot;break}else s=s.parentNode;for(let i of r)l.appendChild(d(null,i,n,l))}else if(a)l.innerHTML=a;else for(let r of e.children)l.appendChild(d(null,r,n,l));return t&&t.replaceWith(l),l}function Z(t,e,n,u){let l=t.attributes,a=new Map;t.$lustre??={__registered_events:new Set};for(let r of e.attrs)r[0]==="class"&&a.has("class")?a.set(r[0],`${a.get("class")} ${r[1]}`):r[0]==="style"&&a.has("style")?a.set(r[0],`${a.get("style")} ${r[1]}`):r[0]==="dangerous-unescaped-html"&&a.has("dangerous-unescaped-html")?a.set(r[0],`${a.get("dangerous-unescaped-html")} ${r[1]}`):r[0]!==""&&a.set(r[0],r[1]);for(let{name:r,value:s}of l)if(!a.has(r))t.removeAttribute(r);else{let i=a.get(r);i!==s&&(m(t,r,i,n),a.delete(r))}for(let r of t.$lustre.__registered_events)if(!a.has(r)){let s=r.slice(2).toLowerCase();t.removeEventListener(s,t.$lustre[`${r}Handler`]),t.$lustre.__registered_events.delete(r),delete t.$lustre[r],delete t.$lustre[`${r}Handler`]}for(let[r,s]of a)m(t,r,s,n);if(customElements.get(e.tag))t._slot=e.children;else if(e.tag==="slot"){let r=t.firstChild,s=new _,i=u;for(;i;)if(i._slot){s=i._slot;break}else i=i.parentNode;for(;r;)Array.isArray(s)&&s.length?d(r,s.shift(),n,t):s.head&&(d(r,s.head,n,t),s=s.tail),r=r.nextSibling;for(let o of s)t.appendChild(d(null,o,n,t))}else if(a.has("dangerous-unescaped-html"))t.innerHTML=a.get("dangerous-unescaped-html");else{let r=t.firstChild,s=e.children;for(;r;)if(Array.isArray(s)&&s.length){let i=r.nextSibling;d(r,s.shift(),n,t),r=i}else if(s.head){let i=r.nextSibling;d(r,s.head,n,t),s=s.tail,r=i}else{let i=r.nextSibling;r.remove(),r=i}for(let i of s)t.appendChild(d(null,i,n,t))}return t}function m(t,e,n,u){switch(typeof n){case(e.startsWith("data-lustre-on-")&&"string"):{if(!n){t.removeAttribute(e),t.removeEventListener(l,t.$lustre[`${e}Handler`]);break}if(t.hasAttribute(e))break;let l=e.slice(15).toLowerCase(),a=r=>u(te(r));t.$lustre[`${e}Handler`]&&t.removeEventListener(l,t.$lustre[`${e}Handler`]),t.addEventListener(l,a),t.$lustre[e]=n,t.$lustre[`${e}Handler`]=a,t.$lustre.__registered_events.add(e),t.setAttribute(e,n);break}case"string":t.getAttribute(e)!==n&&t.setAttribute(e,n),n===""&&t.removeAttribute(e),e==="value"&&t.value!==n&&(t.value=n);break;case(e.startsWith("on")&&"function"):{if(t.$lustre[e]===n)break;let l=e.slice(2).toLowerCase(),a=r=>O(n(r),u);t.$lustre[`${e}Handler`]&&t.removeEventListener(l,t.$lustre[`${e}Handler`]),t.addEventListener(l,a),t.$lustre[e]=n,t.$lustre[`${e}Handler`]=a,t.$lustre.__registered_events.add(e);break}default:t[e]=n}}function Q(t,e){let n=document.createTextNode(e.content);return t&&t.replaceWith(n),n}function ee(t,e){let n=t.nodeValue,u=e.content;return u?(n!==u&&(t.nodeValue=u),t):(t?.remove(),null)}function te(t){let e=t.target,n=e.getAttribute(`data-lustre-on-${t.type}`),u=JSON.parse(e.getAttribute("data-lustre-data")||"{}"),l=JSON.parse(e.getAttribute("data-lustre-include")||"[]");switch(t.type){case"input":case"change":l.push("target.value");break}return{tag:n,data:l.reduce((a,r)=>{let s=r.split(".");for(let i=0,o=a,g=t;i<s.length;i++)i===s.length-1?o[s[i]]=g[s[i]]:(o[s[i]]??={},g=g[s[i]],o=o[s[i]]);return a},u)}}var E=class extends HTMLElement{static get observedAttributes(){return["route"]}#e=null;#t=null;constructor(){super()}connectedCallback(){this.#e=document.createElement("div"),this.appendChild(this.#e)}attributeChangedCallback(e,n,u){switch(e){case"route":if(!u)this.#t?.close(),this.#t=null;else if(n!==u){let l=this.getAttribute("id"),a=u+(l?`?id=${l}`:"");this.#t?.close(),this.#t=new WebSocket(`ws://${window.location.host}${a}`),this.#t.addEventListener("message",({data:r})=>{let[s,...i]=JSON.parse(r);switch(s){case"Diff":return this.patch(i);case"Emit":return this.emit(i)}})}}}patch(e){this.#e=D(e,this.#e,n=>{this.#t?.send(JSON.stringify({$:"Event",tag:n.tag,event:n.data}))})}emit([e,n]){this.#e.dispatchEvent(new CustomEvent(e,{detail:n}))}disconnectedCallback(){this.#t?.close()}};window.customElements.define("lustre-server-component",E);export{E as LustreServerComponent};
