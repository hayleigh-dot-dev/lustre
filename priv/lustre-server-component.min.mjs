var f=class{withFields(t){let n=Object.keys(this).map(l=>l in t?t[l]:this[l]);return new this.constructor(...n)}},w=class{static fromArray(t,n){let l=n||new p;return t.reduceRight((a,s)=>new $(s,a),l)}[Symbol.iterator](){return new k(this)}toArray(){return[...this]}atLeastLength(t){for(let n of this){if(t<=0)return!0;t--}return t<=0}hasLength(t){for(let n of this){if(t<=0)return!1;t--}return t===0}countLength(){let t=0;for(let n of this)t++;return t}};var k=class{#e;constructor(t){this.#e=t}next(){if(this.#e instanceof p)return{done:!0};{let{head:t,tail:n}=this.#e;return this.#e=n,{value:t,done:!1}}}},p=class extends w{},$=class extends w{constructor(t,n){super(),this.head=t,this.tail=n}};var x=class e extends f{static isResult(t){return t instanceof e}},h=class extends x{constructor(t){super(),this[0]=t}isOk(){return!0}},c=class extends x{constructor(t){super(),this[0]=t}isOk(){return!1}};function d(e,t,n,l,a,s){let r=new globalThis.Error(a);r.gleam_error=e,r.module=t,r.line=n,r.fn=l;for(let i in s)r[i]=s[i];return r}var Mt=new DataView(new ArrayBuffer(8));var X=5,A=Math.pow(2,X),qt=A-1,Bt=A/2,Dt=A/4;function O(e,t){if(e.isOk()){let n=e[0];return new h(t(n))}else{if(e.isOk())throw d("case_no_match","gleam/result",67,"map","No case clause matched",{values:[e]});{let n=e[0];return new c(n)}}}function o(e,t,n,l){if(t?.tag&&e?.nodeType===1){let a=t.tag.toUpperCase(),s=t.namespace||"http://www.w3.org/1999/xhtml";return e.nodeName===a&&e.namespaceURI==s?Q(e,t,n,l):B(e,t,n,l)}return t?.tag?B(e,t,n,l):typeof t?.content=="string"?e?.nodeType===3?te(e,t):ee(e,t):document.createComment(["[internal lustre error] I couldn't work out how to render this element. This","function should only be called internally by lustre's runtime: if you think","this is an error, please open an issue at","https://github.com/hayleigh-dot-dev/gleam-lustre/issues/new"].join(" "))}function D(e,t,n){for(let l of t[0]){let a=l[0];if(a==="0")o(e,l[1],n,e.parentNode);else{let s=Array.from(a),r=s.slice(0,-1).join(""),i=s.slice(-1)[0],u=e.querySelector(`[data-lustre-key="${a}"]`)??e.querySelector(`[data-lustre-key="${r}"]`).childNodes[i];o(u,l[1],n,u.parentNode)}}for(let l of t[1]){let a=l[0],s=Array.from(a),r=s.slice(0,-1).join(""),i=s.slice(-1)[0];(e.querySelector(`[data-lustre-key="${a}"]`)??e.querySelector(`[data-lustre-key="${r}"]`).childNodes[i]).remove()}for(let l of t[2]){let a=l[0],s=a==="0"?e:e.querySelector(`[data-lustre-key="${a}"]`);s.$lustre??={__registered_events:new Set};for(let r of l[0])g(s,r.name,r.value,n);for(let r of l[1])if(s.$lustre.__registered_events.has(r)){let i=r.slice(2).toLowerCase();s.removeEventListener(i,s.$lustre[`${r}Handler`]),s.$lustre.__registered_events.delete(r),delete s.$lustre[r],delete s.$lustre[`${r}Handler`]}else s.removeAttribute(r)}return e}function B(e,t,n,l=null){let a=t.namespace?document.createElementNS(t.namespace,t.tag):document.createElement(t.tag);a.$lustre={__registered_events:new Set};let s="";for(let r of t.attrs)r[0]==="class"?g(a,r[0],`${a.className} ${r[1]}`):r[0]==="style"?g(a,r[0],`${a.style.cssText} ${r[1]}`):r[0]==="dangerous-unescaped-html"?s+=r[1]:r[0]!==""&&g(a,r[0],r[1],n);if(customElements.get(t.tag))a._slot=t.children;else if(t.tag==="slot"){let r=new p,i=l;for(;i;)if(i._slot){r=i._slot;break}else i=i.parentNode;for(let u of r)a.appendChild(o(null,u,n,a))}else if(s)a.innerHTML=s;else for(let r of t.children)a.appendChild(o(null,r,n,a));return e&&e.replaceWith(a),a}function Q(e,t,n,l){let a=e.attributes,s=new Map;e.$lustre??={__registered_events:new Set};for(let r of t.attrs)r[0]==="class"&&s.has("class")?s.set(r[0],`${s.get("class")} ${r[1]}`):r[0]==="style"&&s.has("style")?s.set(r[0],`${s.get("style")} ${r[1]}`):r[0]==="dangerous-unescaped-html"&&s.has("dangerous-unescaped-html")?s.set(r[0],`${s.get("dangerous-unescaped-html")} ${r[1]}`):r[0]!==""&&s.set(r[0],r[1]);for(let{name:r,value:i}of a)if(!s.has(r))e.removeAttribute(r);else{let u=s.get(r);u!==i&&(g(e,r,u,n),s.delete(r))}for(let r of e.$lustre.__registered_events)if(!s.has(r)){let i=r.slice(2).toLowerCase();e.removeEventListener(i,e.$lustre[`${r}Handler`]),e.$lustre.__registered_events.delete(r),delete e.$lustre[r],delete e.$lustre[`${r}Handler`]}for(let[r,i]of s)g(e,r,i,n);if(customElements.get(t.tag))e._slot=t.children;else if(t.tag==="slot"){let r=e.firstChild,i=new p,u=l;for(;u;)if(u._slot){i=u._slot;break}else u=u.parentNode;for(;r;)Array.isArray(i)&&i.length?o(r,i.shift(),n,e):i.head&&(o(r,i.head,n,e),i=i.tail),r=r.nextSibling;for(let _ of i)e.appendChild(o(null,_,n,e))}else if(s.has("dangerous-unescaped-html"))e.innerHTML=s.get("dangerous-unescaped-html");else{let r=e.firstChild,i=t.children;for(;r;)if(Array.isArray(i)&&i.length){let u=r.nextSibling;o(r,i.shift(),n,e),r=u}else if(i.head){let u=r.nextSibling;o(r,i.head,n,e),i=i.tail,r=u}else{let u=r.nextSibling;r.remove(),r=u}for(let u of i)e.appendChild(o(null,u,n,e))}return e}function g(e,t,n,l){switch(typeof n){case(t.startsWith("data-lustre-on-")&&"string"):{if(!n){e.removeAttribute(t),e.removeEventListener(a,e.$lustre[`${t}Handler`]);break}if(e.hasAttribute(t))break;let a=t.slice(15).toLowerCase(),s=r=>l(re(r));e.$lustre[`${t}Handler`]&&e.removeEventListener(a,e.$lustre[`${t}Handler`]),e.addEventListener(a,s),e.$lustre[t]=n,e.$lustre[`${t}Handler`]=s,e.$lustre.__registered_events.add(t),e.setAttribute(t,n);break}case"string":e.getAttribute(t)!==n&&e.setAttribute(t,n),n===""&&e.removeAttribute(t),t==="value"&&e.value!==n&&(e.value=n);break;case(t.startsWith("on")&&"function"):{if(e.$lustre[t]===n)break;let a=t.slice(2).toLowerCase(),s=r=>O(n(r),l);e.$lustre[`${t}Handler`]&&e.removeEventListener(a,e.$lustre[`${t}Handler`]),e.addEventListener(a,s),e.$lustre[t]=n,e.$lustre[`${t}Handler`]=s,e.$lustre.__registered_events.add(t);break}default:e[t]=n}}function ee(e,t){let n=document.createTextNode(t.content);return e&&e.replaceWith(n),n}function te(e,t){let n=e.nodeValue,l=t.content;return l?(n!==l&&(e.nodeValue=l),e):(e?.remove(),null)}function re(e){let t=e.target,n=t.getAttribute(`data-lustre-on-${e.type}`),l=JSON.parse(t.getAttribute("data-lustre-data")||"{}"),a=JSON.parse(t.getAttribute("data-lustre-include")||"[]");switch(e.type){case"input":case"change":a.push("target.value");break}return{tag:n,data:a.reduce((s,r)=>{let i=r.split(".");for(let u=0,_=s,b=e;u<i.length;u++)u===i.length-1?_[i[u]]=b[i[u]]:(_[i[u]]??={},b=b[i[u]],_=_[i[u]]);return s},l)}}var E=class extends HTMLElement{static get observedAttributes(){return["route"]}#e=null;#t=null;constructor(){super()}connectedCallback(){this.#e=document.createElement("div"),this.appendChild(this.#e)}attributeChangedCallback(t,n,l){switch(t){case"route":if(!l)this.#t?.close(),this.#t=null;else if(n!==l){let a=this.getAttribute("id"),s=l+(a?`?id=${a}`:"");this.#t?.close(),this.#t=new WebSocket(`ws://${window.location.host}${s}`),this.#t.addEventListener("message",({data:r})=>{let[i,...u]=JSON.parse(r);switch(i){case 0:return this.diff(u);case 1:return this.emit(u);case 2:return this.morph(u)}})}}}morph([t]){this.#e=o(this.#e,t,n=>{this.#t?.send(JSON.stringify({$:"Event",tag:n.tag,event:n.data}))})}diff([t]){this.#e=D(this.#e,t,n=>{this.#t?.send(JSON.stringify({$:"Event",tag:n.tag,event:n.data}))})}emit([t,n]){this.dispatchEvent(new CustomEvent(t,{detail:n}))}disconnectedCallback(){this.#t?.close()}};window.customElements.define("lustre-server-component",E);export{E as LustreServerComponent};
