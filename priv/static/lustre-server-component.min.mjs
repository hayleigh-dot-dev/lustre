function k(i,n,r,s=!1){let t,a=[{prev:i,next:n,parent:i.parentNode}];for(;a.length;){let{prev:e,next:o,parent:u}=a.pop();if(o.subtree!==void 0&&(o=o.subtree()),o.content!==void 0)if(e)if(e.nodeType===Node.TEXT_NODE)e.textContent=o.content,t??=e;else{let l=document.createTextNode(o.content);u.replaceChild(l,e),t??=l}else{let l=document.createTextNode(o.content);u.appendChild(l),t??=l}else if(o.tag!==void 0){let l=$({prev:e,next:o,dispatch:r,stack:a,isComponent:s});e?e!==l&&u.replaceChild(l,e):u.appendChild(l),t??=l}}return t}function T(i,n,r){let s=i.parentNode;for(let t of n[0]){let a=t[0].split("-"),e=t[1],o=N(s,a),u;if(o!==null&&o!==s)u=k(o,e,r);else{let l=N(s,a.slice(0,-1)),h=document.createTextNode("");l.appendChild(h),u=k(h,e,r)}a==="0"&&(i=u)}for(let t of n[1]){let a=t[0].split("-");N(s,a).remove()}for(let t of n[2]){let a=t[0].split("-"),e=t[1],o=N(s,a),u=v.get(o);for(let l of e[0]){let h=l[0],g=l[1];if(h.startsWith("data-lustre-on-")){let b=h.slice(15),d=r(J);u.has(b)||el.addEventListener(b,y),u.set(b,d),el.setAttribute(h,g)}else o.setAttribute(h,g),o[h]=g}for(let l of e[1])if(l[0].startsWith("data-lustre-on-")){let h=l[0].slice(15);o.removeEventListener(h,y),u.delete(h)}else o.removeAttribute(l[0])}return i}function $({prev:i,next:n,dispatch:r,stack:s}){let t=n.namespace||"http://www.w3.org/1999/xhtml",a=i&&i.nodeType===Node.ELEMENT_NODE&&i.localName===n.tag&&i.namespaceURI===(n.namespace||"http://www.w3.org/1999/xhtml"),e=a?i:t?document.createElementNS(t,n.tag):document.createElement(n.tag),o;if(v.has(e))o=v.get(e);else{let c=new Map;v.set(e,c),o=c}let u=a?new Set(o.keys()):null,l=a?new Set(Array.from(i.attributes,c=>c.name)):null,h="",g="",b="";for(let c of n.attrs){let f=c[0],p=c[1];if(c[2])e[f]=p;else if(f.startsWith("on")){let m=f.slice(2),A=r(p);o.has(m)||e.addEventListener(m,y),o.set(m,A),a&&u.delete(m)}else if(f.startsWith("data-lustre-on-")){let m=f.slice(15),A=r(J);o.has(m)||e.addEventListener(m,y),o.set(m,A),e.setAttribute(f,p)}else f==="class"?h=h?h+" "+p:p:f==="style"?g+=p:f==="dangerous-unescaped-html"?b=p:(e.setAttribute(f,p),e[f]=p,a&&l.delete(f))}if(h!==""&&(e.setAttribute("class",h),a&&l.delete("class")),g!==""&&(e.setAttribute("style",g),a&&l.delete("style")),a){for(let c of l)e.removeAttribute(c);for(let c of u)e.removeEventListener(c,y)}if(n.key!==void 0&&n.key!=="")e.setAttribute("data-lustre-key",n.key);else if(b)return e.innerHTML=b,e;let d=i?.firstChild,C=null,w=null,O=null,E=n.children[Symbol.iterator]().next().value;E!==void 0&&E.key!==void 0&&E.key!==""&&(C=new Set,w=L(i),O=L(n));for(let c of n.children)if(c.key!==void 0&&C!==null){for(;d&&!O.has(d.getAttribute("data-lustre-key"));){let p=d.nextSibling;e.removeChild(d),d=p}if(w.size===0){s.unshift({prev:d,next:c,parent:e}),d=d?.nextSibling;continue}if(C.has(c.key)){console.warn(`Duplicate key found in Lustre vnode: ${c.key}`),s.unshift({prev:null,next:c,parent:e});continue}C.add(c.key);let f=w.get(c.key);if(!f&&!d){s.unshift({prev:null,next:c,parent:e});continue}if(!f&&d!==null){let p=document.createTextNode("");e.insertBefore(p,d),s.unshift({prev:p,next:c,parent:e});continue}if(!f||f===d){s.unshift({prev:d,next:c,parent:e}),d=d?.nextSibling;continue}e.insertBefore(f,d),s.unshift({prev:f,next:c,parent:e})}else s.unshift({prev:d,next:c,parent:e}),d=d?.nextSibling;for(;d;){let c=d.nextSibling;e.removeChild(d),d=c}return e}var v=new WeakMap;function y(i){if(!v.has(i.target)){i.target.removeEventListener(i.type,y);return}let n=v.get(i.target);if(!n.has(i.type)){i.target.removeEventListener(i.type,y);return}n.get(i.type)(i)}function J(i){let n=i.target,r=n.getAttribute(`data-lustre-on-${i.type}`),s=JSON.parse(n.getAttribute("data-lustre-data")||"{}"),t=JSON.parse(n.getAttribute("data-lustre-include")||"[]");switch(i.type){case"input":case"change":t.push("target.value");break}return{tag:r,data:t.reduce((a,e)=>{let o=e.split(".");for(let u=0,l=a,h=i;u<o.length;u++)u===o.length-1?l[o[u]]=h[o[u]]:(l[o[u]]??={},h=h[o[u]],l=l[o[u]]);return a},{data:s})}}function L(i){let n=new Map;for(let r of i.children){let s=r.key||r?.getAttribute("data-lustre-key");s&&n.set(s,r)}return n}function N(i,n){let r,s,t=i;for(;[r,...s]=n,r!==void 0;)t=t.childNodes.item(r),n=s;return t}var S=class extends HTMLElement{static get observedAttributes(){return["route"]}#n=null;#t=null;#e=null;constructor(){super(),this.#n=new MutationObserver(n=>{let r=[];for(let s of n)if(s.type==="attributes"){let{attributeName:t,oldValue:a}=s,e=this.getAttribute(t);if(a!==e)try{r.push([t,JSON.parse(e)])}catch{r.push([t,e])}}r.length&&this.#e?.send(JSON.stringify([5,r]))})}connectedCallback(){this.#t=document.createElement("div"),this.appendChild(this.#t)}attributeChangedCallback(n,r,s){switch(n){case"route":if(!s)this.#e?.close(),this.#e=null;else if(r!==s){let t=this.getAttribute("id"),a=s+(t?`?id=${t}`:"");this.#e?.close(),this.#e=new WebSocket(`ws://${window.location.host}${a}`),this.#e.addEventListener("message",e=>this.messageReceivedCallback(e))}}}messageReceivedCallback({data:n}){let[r,...s]=JSON.parse(n);switch(r){case 0:return this.diff(s);case 1:return this.emit(s);case 2:return this.init(s)}}init([n,r]){let s=[];for(let t of n)t in this?s.push([t,this[t]]):this.hasAttribute(t)&&s.push([t,this.getAttribute(t)]),Object.defineProperty(this,t,{get(){return this[`_${t}`]??this.getAttribute(t)},set(a){let e=this[t];typeof a=="string"?this.setAttribute(t,a):this[`_${t}`]=a,e!==a&&this.#e?.send(JSON.stringify([5,[[t,a]]]))}});this.#n.observe(this,{attributeFilter:n,attributeOldValue:!0,attributes:!0,characterData:!1,characterDataOldValue:!1,childList:!1,subtree:!1}),this.morph(r),s.length&&this.#e?.send(JSON.stringify([5,s]))}morph(n){this.#t=k(this.#t,n,r=>s=>{let t=r(s);this.#e?.send(JSON.stringify([4,t.tag,t.data]))})}diff([n]){this.#t=T(this.#t,n,r=>s=>{let t=r(s);this.#e?.send(JSON.stringify([4,t.tag,t.data]))})}emit([n,r]){this.dispatchEvent(new CustomEvent(n,{detail:r}))}disconnectedCallback(){this.#e?.close()}};window.customElements.define("lustre-server-component",S);export{S as LustreServerComponent};
